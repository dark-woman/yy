<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">

<link rel="stylesheet" type="text/css" href="./stylesheets/style.css" />
<script src="ocanvas.min.js"></script>
<script src="jquery-2.0.0.min.js"></script>

<body>

<canvas id="canvas" width="2000" height="1400" style="width:1000px;height:700px;"></canvas>
<div id="item_info">
	title: <span class="title"></span><br>
	detail: <span class="detail"></span>
</div>

<script type="text/javascript">
var canvas = oCanvas.create({
	canvas: "#canvas",
	background: "rgba(0,0,0,1)"
});

var items

var item_clicked = false;
var hovered_item;
var last_hovered_item;
var radius_on_mouse;

$.getJSON("/api/v0/items" , function(data) {
	items = data;

	var coordinate_before_move = {x: 0, y: 0};

	$.each(items, function(i, item) {
		item.circle = canvas.display.arc({
			x: canvas.width * 0.01 * item.feasibility, y: canvas.height * 0.01 * item.scale,
			radius: item.motivation * 3,
			fill: "rgba(255,255,255,1)",
			start: 0,
			end: 360,
			stroke: "4px #fff",
			text: item.title,
		}).add().dragAndDrop({
			start: function() {
				coordinate_before_move = {x: item.circle.x, y: item.circle.y};
			},
			end: function() {
				if( item.circle.x != coordinate_before_move.x || item.circle.y != coordinate_before_move.y ) {
					put_json(item.id, {
						feasibility: Math.round(item.circle.x * 100 / canvas.width),
						scale: Math.round(item.circle.y * 100 / canvas.height),
					})
				} else {
					console.log(item)
				}
			}
		});

		item.text = canvas.display.text({
			origin: { x: "center", y: "center" },
			font: "45px mplus-1c-light",
			text: item.title,
			fill: "#0aa",
		})
		item.circle.addChild(item.text);

		item.circle.bind("mouseenter touchenter", function () {
			item.circle.fill = '0aa';
			item.text.fill = '#fff'
			canvas.redraw();
			$('.title').text(item.title);
			$('.detail').text(item.detail);
			hovered_item = item;
			last_hovered_item = item;
			radius_on_mouse = hovered_item.circle.radius;
			window.addEventListener('mousewheel', mousewheel, false);
		}).bind("mouseleave touchleave", function () {
			if (radius_on_mouse != item.circle.radius){
				put_json(item.id, {
					motivation: Math.round( item.circle.radius / 3 )
				})
			}
			item.circle.fill = "rgba(255,255,255,1)";
			item.text.fill = '#0aa'
			canvas.redraw();
			hovered_item = null;
			window.removeEventListener('mousewheel', mousewheel, false);
		})

		item.circle.bind("dblclick", function () {
			item_clicked = true
			edit($('.detail'));
			edit($('.title'));
			console.log(this)
		})
	})
})

canvas.bind("dblclick", function () {
	if(!item_clicked) {
		alert('Create new item mode.');
		console.log(this)
	}
	item_clicked = false
})

function put_json(item_id, json) {
	$.ajax({
		url: '/api/v0/items/' + item_id ,
		type: 'PUT',
		headers: {
			'X-HTTP-Method-Override': 'PUT',
			'Content-Type': 'application/json'
		},
		dataType: 'json',
		data: JSON.stringify(json),
	}).done(function() {
		item = items[item_id-1];
		canvas.display.arc({
			x: item.circle.x, y: item.circle.y,
			radius: item.circle.radius * 1.1,
			start: 0,
			end: 360,
			stroke: "3px #fff"
		}).add().fadeOut();
	});
}

function mousewheel (event) {
	event.preventDefault();
	if (hovered_item.circle.radius > 200)
		hovered_item.circle.radius = 199;
	else if (hovered_item.circle.radius > 15)
		hovered_item.circle.radius += event.wheelDeltaY;
	else
		hovered_item.circle.radius = 16;
	canvas.redraw();
	return false;
}

$(".title, .detail").dblclick(function() {
	edit($(this));
})

var toggleInput = function(e) {
	edit(e);
};

function edit(dom) {
	var originalContent = dom.text();

	dom.addClass("infoEditing");
	dom.data("originalContent", originalContent);
	var el = document.createElement("input"), $el = $(el);
	$el.attr({type: "text", value: originalContent});
	$el.css("fontSize", dom.css("fontSize"));
	dom.empty();
	dom.append(el);
	$el.focus();

	$el.keypress(function(e) {
		if (e.which == 13) {
			post(dom);
		}
	});

	var resetContent = function(e) {
		var td = $(e.target).parent();
		td.text(td.data("originalContent"));
		td.removeData("originalContent");
		td.removeClass("infoEditing");
	};

	var post = function (dom) {
		var title = $('.title').children('input').val();
		var detail = $('.detail').children('input').val();
		put_json(last_hovered_item.id, {
			title: title,
			detail: detail,
		})
		$('.title').text(title);
		$('.detail').text(detail);
		last_hovered_item.text.text = $('.title').text();
		$(dom).removeData("originalContent");
		$(dom).removeClass("infoEditing");
		return false;
	}

	$el.keydown(function(e) {
		if (e.which == 27) {
			resetContent(e);
		}
	});
}

</script>
</body>
</html>